<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Interactive Sites Map</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --shadow:0 8px 30px rgba(0,0,0,0.12);
  --radius:12px;
}
html,body{
  margin:0;height:100%;font-family:Arial;background:#e0eaff;color:#222;
}
.app{
  display:grid;grid-template-columns:380px 1fr;gap:16px;height:100vh;
  padding:16px;box-sizing:border-box;
}
.panel{
  background:#fff;border-radius:var(--radius);padding:16px;
  box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:auto;
}
#map{
  height:100%;border-radius:var(--radius);box-shadow:var(--shadow);
  border:2px solid rgba(0,0,0,0.3);position:relative;
}
.statRow{
  display:flex;gap:12px;margin-bottom:12px;
}
.stat{
  background:#fff;flex:1;padding:12px;border-radius:var(--radius);
  box-shadow:0 4px 12px rgba(0,0,0,0.08);text-align:center;
}
.stat .small{
  font-weight:500;color:#555;margin-bottom:4px;
}
.legend{
  display:flex;flex-direction:column;gap:6px;margin-top:20px;
}
.legend .item{
  display:flex;align-items:center;cursor:pointer;
}
.legend .color{
  width:16px;height:16px;border-radius:50%;margin-right:8px;
  border:2px solid #fff;box-shadow:0 0 4px rgba(0,0,0,0.25);
}

.details{
  margin-top:10px;padding:10px;background:#fff;border-radius:var(--radius);
}

.marker-size-popup{
  position:absolute;background:white;padding:10px;border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.2);z-index:9999;
}

</style>
</head>

<body>
<div class="app">
  <div class="panel">

    <h2>Site Map Dashboard</h2>

    <label>Filter by Cluster</label>
    <select id="clusterSelect">
      <option value="all">All Clusters</option>
    </select>

    <div style="display:flex; gap:8px; margin-bottom:12px;">
      <input type="text" id="siteSearch" placeholder="Type exact site name..." style="flex:1;">
      <button id="siteFindBtn">Find</button>
    </div>

    <!-- FIRST ROW: Fixed Panels -->
    <div class="statRow">
      <div class="stat"><div class="small">Completed / Total</div><div id="doneTotal">0 / 0</div><div id="donePct" class="small">0%</div></div>
      <div class="stat"><div class="small">Pending</div><div id="pendingCount">0</div><div class="small" id="totalCount">Total: 0</div></div>
    </div>

    <!-- EXTRA STATUS PANELS GENERATED HERE -->
    <div id="extraStatusPanels"></div>

    <!-- LEGEND -->
    <div class="legend" id="legendContainer"></div>

    <div id="details" class="details">Hover a marker to see details here.</div>

  </div>

  <!-- MAP PANEL -->
  <div class="panel" style="padding:0;">
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ------------------------------ CONFIG ------------------------------*/
let allRows = [], visibleMarkers = {}, pinnedMarker = null, lastCsvText = "";
const STATUS_COLORS = JSON.parse(localStorage.getItem('markerColors')||"{}");
const STATUS_SIZES = JSON.parse(localStorage.getItem('markerSizes')||"{}");
const DEFAULT_COLORS = ['#66ff00','#2F80ED','#FF0000','#FF9900','#A020F0','#FFFF00'];

/* ------------------------------ MAP ------------------------------*/
const map = L.map('map',{preferCanvas:true}).setView([3,101.5],6);
L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {maxZoom:20}).addTo(map);
const markersLayer = L.layerGroup().addTo(map);

/* ------------------------------ MARKER ICON ------------------------------*/
function dotIcon(color, size){
  size = size || 8;
  return L.divIcon({
    className:'',
    html:`<div style="width:${size}px;height:${size}px;background:${color};
          border-radius:50%;border:2px solid #fff;
          box-shadow:0 0 4px rgba(0,0,0,0.25);"></div>`,
    iconSize:[size+4, size+4],
    iconAnchor:[(size+4)/2, (size+4)/2]
  });
}

/* ------------------------------ LOAD CSV ------------------------------*/
function loadCsv(text){
  const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
  allRows = parsed.data.map((r,i)=>({
    _i:i,
    site:(r["Site Name"]||"").trim(),
    cluster:(r["Cluster"]||"").trim(),
    status:(r["Status"]||"").trim(),
    lat:parseFloat(r["Latitude"]),
    lon:parseFloat(r["Longitude"])
  }));
  populateCluster();
  render();
}

function populateCluster(){
  const sel=document.getElementById("clusterSelect");
  sel.innerHTML='<option value="all">All Clusters</option>';
  [...new Set(allRows.map(r=>r.cluster))].filter(x=>x).forEach(c=>{
    sel.innerHTML+=`<option value="${c}">${c}</option>`;
  });
}

document.getElementById("clusterSelect").addEventListener("change",render);

/* ------------------------------ RENDER ------------------------------*/
function render(){
  markersLayer.clearLayers();
  visibleMarkers={};
  
  const clusterFilter=document.getElementById("clusterSelect").value;
  const bounds=[];

  let completed=0, pending=0;

  const statusCounts={};

  allRows.forEach(r=>{
    if(!Number.isFinite(r.lat)||!Number.isFinite(r.lon)) return;
    if(clusterFilter!=='all' && r.cluster!==clusterFilter) return;

    if(!STATUS_COLORS[r.status]){
      STATUS_COLORS[r.status]=DEFAULT_COLORS[ Object.keys(STATUS_COLORS).length % DEFAULT_COLORS.length ];
    }
    if(!STATUS_SIZES[r.status]) STATUS_SIZES[r.status]=8;

    if(r.status==="Completed") completed++;
    else pending++;

    statusCounts[r.status]=(statusCounts[r.status]||0)+1;

    const marker=L.marker([r.lat,r.lon],{
      icon:dotIcon(STATUS_COLORS[r.status], STATUS_SIZES[r.status])
    });

    const html=`<strong>${r.site}</strong><br>Cluster: ${r.cluster}<br>Status: ${r.status}`;
    marker.bindPopup(html);

    marker.on("mouseover",()=>{ marker.openPopup(); document.getElementById("details").innerHTML=html; });
    marker.on("mouseout",()=>{ if(pinnedMarker!==marker) marker.closePopup(); });
    marker.on("click",()=>{ if(pinnedMarker) pinnedMarker.closePopup(); pinnedMarker=marker; });

    marker.addTo(markersLayer);
    visibleMarkers["row"+r._i]=marker;
    bounds.push([r.lat,r.lon]);
  });

  updateMainStats(completed, pending);
  buildExtraStatusPanels(statusCounts);

  if(bounds.length){
    const b=L.latLngBounds(bounds);
    if(b.isValid()) map.fitBounds(b.pad(0.2));
  }

  buildLegend(statusCounts);
}

/* ------------------------------ MAIN PANELS ------------------------------*/
function updateMainStats(done,pending){
  const total=done+pending;
  document.getElementById("doneTotal").innerText=`${done} / ${total}`;
  document.getElementById("pendingCount").innerText=pending;
  document.getElementById("donePct").innerText = total ? Math.round(done/total*100)+"%" : "0%";
  document.getElementById("totalCount").innerText="Total: "+total;
}

/* ------------------------------ EXTRA STATUS PANELS ------------------------------*/
function buildExtraStatusPanels(counts){
  const container=document.getElementById("extraStatusPanels");
  container.innerHTML='';

  const excluded=["Completed","Pending"];

  const list = Object.keys(counts).filter(s=>!excluded.includes(s));

  let row;
  list.forEach((status,i)=>{
    if(i%2===0){
      row=document.createElement("div");
      row.className="statRow";
      container.appendChild(row);
    }
    const div=document.createElement("div");
    div.className="stat";
    div.innerHTML=`<div class="small">${status}</div><div>${counts[status]}</div>`;
    row.appendChild(div);
  });
}

/* ------------------------------ LEGEND ------------------------------*/
function buildLegend(counts){
  const legend=document.getElementById("legendContainer");
  legend.innerHTML='';

  Object.keys(counts).forEach(status=>{
    const item=document.createElement("div");
    item.className="item";

    const colorBox=document.createElement("div");
    colorBox.className="color";
    colorBox.style.background=STATUS_COLORS[status];

    colorBox.addEventListener("click",(e)=>{
      e.stopPropagation();
      openLegendPopup(e.clientX, e.clientY, status, colorBox);
    });

    item.appendChild(colorBox);
    item.appendChild(document.createTextNode(status));
    legend.appendChild(item);
  });
}

/* ------------------------------ POPUP: COLOR + SIZE ------------------------------*/
let activePopup=null;

function openLegendPopup(x,y,status,element){
  if(activePopup){ activePopup.remove(); }

  const rect=element.getBoundingClientRect();
  const popup=document.createElement("div");
  popup.className="marker-size-popup";
  popup.style.left = rect.right + 10 + "px";
  popup.style.top = rect.top + "px";

  popup.innerHTML = `
    <input type="color" id="colorInput" value="${STATUS_COLORS[status]}" style="width:100%;margin-bottom:10px;">
    <input type="range" min="4" max="30" value="${STATUS_SIZES[status]}" id="sizeInput" style="width:100%;">
  `;

  document.body.appendChild(popup);
  activePopup=popup;

  popup.querySelector("#colorInput").addEventListener("input",e=>{
    STATUS_COLORS[status]=e.target.value;
    localStorage.setItem("markerColors",JSON.stringify(STATUS_COLORS));
    render();
  });

  popup.querySelector("#sizeInput").addEventListener("input",e=>{
    STATUS_SIZES[status]=parseInt(e.target.value);
    localStorage.setItem("markerSizes",JSON.stringify(STATUS_SIZES));
    render();
  });

  document.addEventListener("click", closePopupOutside);
}

function closePopupOutside(e){
  if(activePopup && !activePopup.contains(e.target)){
    activePopup.remove();
    activePopup=null;
    document.removeEventListener("click", closePopupOutside);
  }
}

/* ------------------------------ SEARCH ------------------------------*/
document.getElementById("siteFindBtn").addEventListener("click",findSite);
document.getElementById("siteSearch").addEventListener("keypress",(e)=>{ if(e.key==="Enter") findSite();});

function findSite(){
  const t=document.getElementById("siteSearch").value.trim().toLowerCase();
  if(!t) return;

  for(let key in visibleMarkers){
    const rowIndex=parseInt(key.replace("row",""));
    const r=allRows[rowIndex];
    if(r.site.toLowerCase()===t){
      const m=visibleMarkers[key];
      m.openPopup();
      map.setView(m.getLatLng(),16);
      return;
    }
  }
  alert("Site not found.");
}

/* ------------------------------ GOOGLE SHEET AUTO-FETCH ------------------------------*/
async function fetchCsv(){
  const url="https://docs.google.com/spreadsheets/d/e/2PACX-1vQq9pqO7KbSPXQ2tYVnl-kKw-XgEw0uwqpMn-py2Spo67ZikKfQf63XtoxL0MxuUYzwAPkiQLOAu4dx/pub?output=csv&_t="+Date.now();
  try{
    const r=await fetch(url,{cache:"no-store"});
    const text=await r.text();
    if(text!==lastCsvText){
      lastCsvText=text;
      loadCsv(text);
    }
  } catch(err){ console.error(err); }
}

fetchCsv();
setInterval(fetchCsv, 30000);

</script>
</body>
</html>
