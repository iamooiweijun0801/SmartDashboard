<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Interactive Sites Map</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --shadow:0 8px 30px rgba(0,0,0,0.12);
  --radius:12px;
}
html, body { margin:0; height:100%; font-family: Arial; background:#e0eaff; color:#222; font-size:14px; line-height:1.5; }
.app{ display:grid; grid-template-columns:380px 1fr; gap:16px; height:100vh; padding:16px; box-sizing:border-box; }
.panel{ background:#fff; border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:auto; }
#map{ height:100%; border-radius:var(--radius); box-shadow:var(--shadow); border:2px solid rgba(0,0,0,0.3); position:relative; }
h2{ margin-bottom:12px; font-weight:700; font-size:1.4em; color:#1a1a1a; }
label{ font-weight:600; color:#333; margin-bottom:6px; }
select{ padding:6px 10px; border-radius:var(--radius); border:1px solid #ccc; margin-bottom:12px; }
.statRow{ display:flex; gap:12px; margin-bottom:12px; }
.stat{ background:rgba(255,255,255,0.85); flex:1; padding:12px; border-radius:var(--radius); box-shadow:0 4px 12px rgba(0,0,0,0.08); text-align:center; transition:0.2s; }
.stat:hover{ box-shadow:0 6px 18px rgba(0,0,0,0.15); transform:translateY(-2px); }
.stat .small{ font-weight:500; color:#555; margin-bottom:4px; }
.stat div[id]{ font-weight:700; font-size:20px; margin-top:4px; }
.legend{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
.legend .item{ display:flex; align-items:center; cursor:pointer; }
.legend .color{ width:16px; height:16px; border-radius:50%; margin-right:8px; border:2px solid #fff; box-shadow:0 0 4px rgba(0,0,0,0.25); }
#details{ font-size:14px; color:#222; margin-top:8px; padding:8px; border-radius:var(--radius); background:rgba(255,255,255,0.7); box-shadow:0 4px 12px rgba(0,0,0,0.08); min-height:80px; }
.map-sniper-btn{position:absolute;bottom:20px;right:20px;z-index:9999;width:50px;height:50px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid #444;box-shadow:0 2px 8px rgba(0,0,0,0.25);}
.map-sniper-btn img{width:28px;height:28px;}
.map-sniper-btn:hover{transform:translateY(-4px);box-shadow:0 6px 18px rgba(0,0,0,0.28);}
</style>
</head>
<body>
<div class="app">
  <div class="panel">
    <h2>Site Map Dashboard</h2>
    <label for="clusterSelect">Filter by Cluster</label>
    <select id="clusterSelect"><option value="all">All Clusters</option></select>

    <div class="statRow">
      <div class="stat">
        <div class="small">Completed / Total</div>
        <div id="doneTotal">0 / 0</div>
        <div class="small" id="donePct">0%</div>
      </div>
      <div class="stat">
        <div class="small">Pending</div>
        <div id="pendingCount">0</div>
        <div class="small" id="totalCount">Total: 0</div>
      </div>
    </div>

    <div class="legend" id="legendContainer"></div>
    <div id="details">Hover or click a marker to see details here.</div>
  </div>

  <div class="panel" style="padding:0;">
    <div id="map">
      <div id="sniperBtn" class="map-sniper-btn" title="Reset view">
        <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="Reset View">
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-ajax"></script> <!-- for GeoJSON loading -->

<script>
const map = L.map('map',{preferCanvas:true}).setView([3.0,101.5],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const markersLayer = L.layerGroup().addTo(map);
let allRows=[], visibleMarkers={}, pinnedMarker=null;
const STATUS_COLORS = {};
const DEFAULT_STATUS_COLORS = ['#66ff00','#2F80ED','#FF0000','#FF9900','#FFA500','#888'];

// Polygon clusters
const clusterColors = {};
const DEFAULT_CLUSTER_COLORS = ['#ff6666','#66ff66','#6699ff','#ffcc66','#cc66ff','#66ffff','#ff66cc'];
let polygonsLayer = L.layerGroup().addTo(map);

function dotIcon(color){
  return L.divIcon({className:'', html:`<div style="width:12px;height:12px;background:${color};border-radius:50%;border:2px solid #fff;box-shadow:0 0 4px rgba(0,0,0,0.25);"></div>`, iconSize:[14,14], iconAnchor:[7,7], popupAnchor:[0,-10]});
}

function loadCsvText(text){
  const parsed = Papa.parse(text,{header:true, skipEmptyLines:true});
  allRows = parsed.data.map((r,i)=>(({
    _rowIndex:i,
    site_name:(r['Site Name']||'').trim(),
    cluster:(r['Cluster']||'').trim(),
    status:(r['Status']||'').trim(),
    lat:parseFloat((r['Latitude']||'').replace(/,/g,'.'))||NaN,
    lon:parseFloat((r['Longitude']||'').replace(/,/g,'.'))||NaN
  })));
  populateClusterFilter();
  render();
}

function populateClusterFilter(){
  const clusterSet = new Set(allRows.map(r=>r.cluster).filter(c=>c));
  const select = document.getElementById('clusterSelect');
  select.innerHTML = '<option value="all">All Clusters</option>';
  clusterSet.forEach(c=>{ const o=document.createElement('option'); o.value=c;o.textContent=c;select.appendChild(o); });
}

function render(){
  markersLayer.clearLayers(); visibleMarkers={};
  const bounds=[], selectedCluster=document.getElementById('clusterSelect').value;
  let doneCount=0,pendingCount=0;

  allRows.forEach(r=>{
    if(!Number.isFinite(r.lat)||!Number.isFinite(r.lon)) return;
    if(selectedCluster!=='all' && r.cluster!==selectedCluster) return;

    if(!STATUS_COLORS[r.status]) STATUS_COLORS[r.status] = DEFAULT_STATUS_COLORS[Object.keys(STATUS_COLORS).length % DEFAULT_STATUS_COLORS.length];
    const color = STATUS_COLORS[r.status];
    const icon = dotIcon(color);

    const popupHtml = `<div style="min-width:220px">
      <strong>${r.site_name}</strong><br/>
      <em>Cluster:</em> ${r.cluster}<br/>
      <em>Status:</em> ${r.status}
    </div>`;

    const m = L.marker([r.lat,r.lon],{icon});
    m.bindPopup(popupHtml,{autoClose:false,closeOnClick:false});
    m.on('mouseover',()=>{ if(pinnedMarker && pinnedMarker!==m)pinnedMarker.closePopup(); pinnedMarker=null; m.openPopup(); document.getElementById('details').innerHTML=popupHtml; });
    m.on('mouseout',()=>{ if(pinnedMarker!==m)m.closePopup(); });
    m.on('click',()=>{ if(pinnedMarker && pinnedMarker!==m)pinnedMarker.closePopup(); pinnedMarker=m; m.openPopup(); document.getElementById('details').innerHTML=popupHtml; map.setView(m.getLatLng(),16); });
    m.addTo(markersLayer);
    visibleMarkers['row'+r._rowIndex]=m;
    bounds.push([r.lat,r.lon]);

    if(r.status==='Completed') doneCount++; else pendingCount++;
  });

  animateValue('doneTotal',0,doneCount,doneCount+pendingCount);
  animateValue('pendingCount',0,pendingCount);
  document.getElementById('donePct').textContent = (doneCount+pendingCount)? Math.round(doneCount/(doneCount+pendingCount)*10000)/100+'%':'0%';
  document.getElementById('totalCount').textContent = `Total: ${doneCount+pendingCount}`;

  if(bounds.length){ const b=L.latLngBounds(bounds); if(b.isValid()) map.fitBounds(b.pad(0.2)); }

  generateLegend();
}

// Animate numbers
function animateValue(id, start, end, total){
  const obj=document.getElementById(id); if(!obj) return;
  let startTimestamp=null;
  const duration=500;
  const step=timestamp=>{
    if(!startTimestamp) startTimestamp=timestamp;
    const progress=Math.min((timestamp-startTimestamp)/duration,1);
    const current=Math.floor(progress*(end-start)+start);
    obj.textContent=total? `${current} / ${total}` : current;
    if(progress<1) window.requestAnimationFrame(step);
  };
  window.requestAnimationFrame(step);
}

// Legend
function generateLegend(){
  const legendContainer = document.getElementById('legendContainer');
  legendContainer.innerHTML = '';
  const statuses = Array.from(new Set(allRows.map(r=>r.status).filter(s=>s)));
  
  statuses.forEach((status,i)=>{
    if(!STATUS_COLORS[status]) STATUS_COLORS[status] = DEFAULT_STATUS_COLORS[i % DEFAULT_STATUS_COLORS.length];
    const item = document.createElement('div'); item.className='item';
    const colorDiv = document.createElement('div'); colorDiv.className='color';
    colorDiv.setAttribute('data-status',status); colorDiv.style.background = STATUS_COLORS[status];

    colorDiv.addEventListener('click', ()=>{
      const input = document.createElement('input'); input.type='color';
      input.value = rgbToHex(window.getComputedStyle(colorDiv).backgroundColor);
      input.style.position='fixed'; input.style.left='50%'; input.style.top='50%'; input.style.width='50px'; input.style.height='50px';
      document.body.appendChild(input); input.click();
      input.addEventListener('input',()=>{ STATUS_COLORS[status]=input.value; colorDiv.style.background=input.value; updateMarkerColors(status,input.value); });
      input.addEventListener('change',()=>document.body.removeChild(input));
      input.addEventListener('blur',()=>document.body.removeChild(input));
    });

    item.appendChild(colorDiv); item.appendChild(document.createTextNode(status));
    legendContainer.appendChild(item);
  });
}

function updateMarkerColors(status,newColor){
  for(const key in visibleMarkers){
    const m = visibleMarkers[key];
    const row = allRows.find(r=>'row'+r._rowIndex === key);
    if(row && row.status===status) m.setIcon(dotIcon(newColor));
  }
}

function rgbToHex(rgb){ if(rgb.startsWith('#')) return rgb; const nums=rgb.match(/\d+/g).map(Number); return '#'+nums.map(n=>n.toString(16).padStart(2,'0')).join(''); }

document.getElementById('clusterSelect').addEventListener('change',render);
document.getElementById('sniperBtn').addEventListener('click',render);

// Load polygons from GeoJSON
fetch('smartcluster.geojson')
  .then(r=>r.json())
  .then(data=>{
    polygonsLayer.clearLayers();
    L.geoJSON(data, {
      style: feature => {
        const name = feature.properties.Name;
        if(!clusterColors[name]) clusterColors[name] = DEFAULT_CLUSTER_COLORS[Object.keys(clusterColors).length % DEFAULT_CLUSTER_COLORS.length];
        return {color: clusterColors[name], fillColor: clusterColors[name], fillOpacity: 0.3, weight: 2};
      },
      onEachFeature: (feature, layer) => {
        layer.bindPopup(`<strong>Cluster:</strong> ${feature.properties.Name}`);
      }
    }).addTo(polygonsLayer);
  });

// Auto-refresh CSV
const SHEET_CSV_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vQq9pqO7KbSPXQ2tYVnl-kKw-XgEw0uwqpMn-py2Spo67ZikKfQf63XtoxL0MxuUYzwAPkiQLOAu4dx/pub?gid=0&single=true&output=csv';
let lastCsvText=null;
async function smartFetchCsv(){
  try{
    const response=await fetch(SHEET_CSV_URL);
    if(!response.ok) throw new Error('Network response not ok');
    const csvText=await response.text();
    if(csvText!==lastCsvText){ lastCsvText=csvText; loadCsvText(csvText); }
  }catch(err){ console.error('CSV fetch error:',err);}
}
smartFetchCsv();
setInterval(smartFetchCsv,30000);
</script>
</body>
</html>
